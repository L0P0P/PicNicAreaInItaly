<!-- This is a static file -->
<!-- served from your routes in server.js -->
<!-- https://leafletjs.com/examples/quick-start/ -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <link href="/favicon.ico" type="image/x-icon" rel="icon" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A cool thing made with Glitch">

    <title>PicNic Area - Italia</title>

    <!-- <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon"> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
   integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
   crossorigin=""/>

    <!-- Make sure you put this AFTER Leaflet's CSS -->
   <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin=""></script>

   <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- CSS style of the map -->
  <style>
    #mapid { height: 350px; }
  </style>
  </head>
  
  <body style="background-color: red;
               background-image:
                 linear-gradient(45deg, white 25%, transparent 25%, transparent 75%, white 75%, white),
                 linear-gradient(-45deg,white 25%,transparent 25%,transparent 75%,white 75%,white); 
               background-size: 40px 40px;
               background-repeat: repeat;">
    <script>
      function redirect(link) {
      window.location.href = link;
      }
    </script>

    <div class="container-fluid text-center" style="margin-bottom: 0.7cm;
                                                    margin-top: 0.7cm;
                                                    background-color: white;">
        <h1>
          <img
          src="https://previews.123rf.com/images/greatnotions/greatnotions1509/greatnotions150908610/45169705-una-sala-da-camper-da-pranzo-%C3%A8-un-tavolo-da-picnic-in-un-parco-prendete-questo-disegno-con-voi-sul-v.jpg"
          alt="Disegno cesto da PicNic"
          class="img-fluid"
          style="margin-top: 0.2cm;
          margin-bottom: 0.2cm;" 
          height="10%"
          width="10%"
          />
        PicNic Area
      </h1>

      <button
          type="button"
          class="btn"
          style="background-color: rgba(255, 0, 0, 0.7);
                color: black; 
                border: 3px solid black;
                border-radius: 1em;
                border-collapse: separate;
                overflow: hidden;
                font-size: 20px;
                vertical-align: middle;
                margin-top: 0.1cm;
                margin-bottom: 0.2cm;"
          onclick="window.location.href ='/';"
        >
          Torna alla pagina iniziale
      </button>
    </div>
    <br />

    <main>
      <div id="mapid" style="border: 3px solid black;
                             border-radius: 1em;
                             border-collapse: separate;
                             overflow: hidden;
                             margin-left: 10%;
                             margin-right: 10%;"></div>
      <br />
      <div class="text-center" style="background-color: white;
                                      margin-left: 10%;
                                      margin-right: 10%;">
        <h3>Lista completa</h3>
        <table class=" table-hover">
          <thead style="background-color: white; color: black; border: 3px solid black">
            <th scope="col">Nome</th>
            <th scope="col">Comune</th>
            <th scope="col">Provincia</th>
            <th scope="col">Regione</th>
          </thead>
          <tbody id="tabellaaree"></tbody>
        </table>
      </div>

      <script>
        const attribution ='&copy; <a href="htts://www.openstreetmap.org/copyright"> OpenStreetMap </a>contributors';
        const tUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
        const tiles = L.tileLayer(tUrl, {attribution})
        var map = L.map('mapid');
        map.addLayer(tiles);
        const latRoma = 41.9109;
        const lonRoma = 12.4818;
        map.setView([latRoma, lonRoma], 10);
        
        window.addEventListener('load', setupStrutture);

        async function setupStrutture() {
        const strutture = await getStrutture();
          for (let i = 2; i < strutture.markersInfo.length; i +=2) {
            //console.log("lat: " + strutture.markersInfo[i][0] + " lon: " +strutture.markersInfo[i][1] + " Descrizione: " + strutture.markersInfo[i+1]);
            //console.log("i=" + i + " " + strutture.markersInfo[i]);
            var lon = strutture.markersInfo[i][0];
            var lat = strutture.markersInfo[i][1];
            var descrizione = strutture.markersInfo[i+1];
            
            if(!isNaN(lat) && !isNaN(lon)){
             var markerStruttura = new L.LatLng(lat, lon);
             var marker = new L.Marker(markerStruttura);
             marker.bindPopup(descrizione);
             marker.addTo(map);
            } else {
              //console.log("Posizione assente per " + descrizione)
              const par = document.getElementById("pid");
              par.innerHTML += descrizione;
            }
          }
        }  
        
        async function getStrutture() {
          const response = await fetch('/rawdata');
          const data = await response.text();
          const markersInfo = []; //[[lat,lon], descrizione]
          const rows = data.split('\n'); // Categoria,Classificazione,Denominazione,LocalitÃ ,Web,Latitudine,Longitudine
          let flag = false;

          rows.forEach(row => {
            const cols = row.split(';');
            const descrizione = "Nome:" + cols[3] + "<br>" + "Comune: " + cols[0] + "<br>" +
                                "Provincia: " + cols[1] + "<br>" + "Regione: " + cols[2] + "</a><br><br>"
            //console.log("Descrizione: " + descrizione);
            if(flag && cols[0] !== 'ALTRO' && cols[1] !== 'ALTRO' && cols[2] !== 'ALTRO'
                    && cols[0] !== undefined && cols[1] !== undefined && cols[2] !== undefined) {
              markersInfo.push([parseFloat(cols[7]), parseFloat(cols[8])]);
              markersInfo.push(descrizione);
            
              rigaTabella =
                '<tr class="fw-lighter"><th scope="row">' +
                cols[3] + "</th>" + "<td>" + cols[0] + "</td>" +
                "<td>" + cols[1] + "</td>" + "<td>" + cols[2] + "</td>";

              document.getElementById("tabellaaree").innerHTML += rigaTabella;
            } else {
              flag = true;
            }
          });
            return { markersInfo }; 
        }

      </script>
    </main>
  </body>
</html>